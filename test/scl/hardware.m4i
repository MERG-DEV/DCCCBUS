divert(-1)
define(wait_until_idle;)

define(enter_learn_mode,
       rx_data(OPC_NNLRN, $1, $2) -- NNLRN, CBUS enter learn mode
       wait_until_idle)

define(exit_learn_mode,
       rx_data(OPC_NNULN, $1, $2) -- NNULN, CBUS exit learn mode
       wait_until_idle)

define(flim_led, RB6)
define(slim_led, RB7)

define(confirm_not_flim,
      if flim_led == '1' then
        log(Yellow LED (FLiM) on)
        test_state := fail;
      end if;)

define(confirm_flim,
      if flim_led != '1' then
        log(Yellow LED (FLiM) off)
        test_state := fail;
      end if;)

define(confirm_not_slim,
      if slim_led == '1' then
        log(Green LED (SLiM) on)
        test_state := fail;
      end if;)

define(confirm_slim,
      if slim_led != '1' then
        log(Green LED (SLiM) off)
        test_state := fail;
      end if;)

define(wait_until_flim,
       wait until flim_led == '1';
       log(Yellow LED (FLiM) on)
       confirm_not_slim)

define(wait_until_slim,
       wait until slim_led == '1';
       log(Green LED (SLiM) on)
       confirm_not_flim)

define(configure_can,
       if CANCON.REQOP2 != '1' then
         log(Waiting to configure CAN)
         wait until CANCON.REQOP2 == '1';
       end if;
       CANSTAT.OPMODE2 <= '1';
       log(Configuring CAN)
       wait until CANCON.REQOP2 == '0';
       CANSTAT.OPMODE2 <= '0';
       log(CAN configured))

define(setup_button, RA2)
define(set_setup_off, setup_button <= '1';)
define(set_setup_on, setup_button <= '0';)

define(dcc_input, INT0)
define(set_dcc_off, dcc_input <= '0';)
define(set_dcc_on, dcc_input <= '1';)

divert(0)dnl
