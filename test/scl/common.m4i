divert(-1)
changecom(--)
changequote({,})

define(set_test_name, {define(test_name, patsubst(__file__, {.m4},))})

define(log, {report("test_name: $1");})

define(processor_type, PIC18F2480)

define(timeout_process,
       test_timeout: process is
         begin
           wait for $1 ms;
           log(TIMEOUT)
           report(PC); -- Crashes simulator, MDB will report current source line
           stop_test
         end process test_timeout;)

define(beginning_of_test,
       configuration for "processor_type" is
         {ifelse( $2, {}, {--}, shared $2;)}
         {ifelse( $3, {}, {--}, shared $3;)}
       end configuration;
       --
       testbench for "processor_type" is
       begin
         timeout_process($1)
           --
         test_name: process is
           type test_result is (pass, fail);
           variable test_state   : test_result;)

define(begin_test,
       begin
         log(START)
         test_state := pass;
         --
         set_paired_outputs_off
         set_rcn213_linear_addressing_off
         set_cancmd_addressing_off)

define(stop_test,
       PC <= 0;
       wait;)

define(end_of_test,
         if test_state == pass then
           log(PASS)
         else
           log(FAIL)
         end if;
         stop_test
         end process test_name;
       end testbench;)

define(low_byte, {eval(0xFF & $1)})
define(high_byte, {eval(0xFF & ($1 >> 8))})

divert(0)dnl
